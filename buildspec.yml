# ===============================================================
# buildspec.yml - Automa√ß√£o de Build e Push para Amazon ECR
# ===============================================================
# 1Ô∏è‚É£ Faz login no ECR
# 2Ô∏è‚É£ Busca a √∫ltima tag vX.Y.Z
# 3Ô∏è‚É£ Incrementa a vers√£o (ex: v0.0.1 ‚Üí v0.0.2)
# 4Ô∏è‚É£ Builda a imagem Docker
# 5Ô∏è‚É£ Faz push com a nova tag e tamb√©m com 'latest'
# ===============================================================

version: 0.2

env:
  variables:
    REPO_NAME: "poc-github"
    REGION: "us-east-1"

phases:
  install:
    commands:
      - echo "üß© Fase de instala√ß√£o inicial..."
      - yum install -y jq

  pre_build:
    commands:
      - echo "üîê Fazendo login no Amazon ECR..."
      - ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
      - ECR_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${REPO_NAME}"
      - aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com"
      - echo "üîç Buscando √∫ltima tag v√°lida no ECR (${REPO_NAME})..."
      - TAGS=$(aws ecr describe-images --repository-name "$REPO_NAME" --region "$REGION" --query 'imageDetails[].imageTags' --output json 2>/dev/null | jq -r '.[]? | .[]? | select(test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))' | sort -V || true)
      - 'if [ -z "$TAGS" ]; then NEW_TAG="v0.0.1"; echo "‚ö†Ô∏è Nenhuma tag encontrada ‚Äî iniciando em v0.0.1"; else LAST_TAG=$(echo "$TAGS" | tail -n 1); echo "‚úÖ √öltima tag encontrada: $LAST_TAG"; VERSION=${LAST_TAG#v}; IFS="." read -r MAJOR MINOR PATCH <<< "$VERSION"; PATCH=$((PATCH+1)); NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"; fi'
      - echo "üöÄ Nova tag gerada: $NEW_TAG"
      - echo "TAG_FINAL=$NEW_TAG" >> build.env
      - echo "ECR_URI=$ECR_URI" >> build.env

  build:
    commands:
      - echo "üèóÔ∏è Construindo imagem Docker..."
      - source build.env
      - echo "Imagem: ${ECR_URI}:${TAG_FINAL}"
      - docker build -t "${ECR_URI}:${TAG_FINAL}" .
      - docker tag "${ECR_URI}:${TAG_FINAL}" "${ECR_URI}:latest"

  post_build:
    commands:
      - echo "üì§ Enviando imagem para o ECR..."
      - source build.env
      - docker push "${ECR_URI}:${TAG_FINAL}"
      - docker push "${ECR_URI}:latest"
      - echo "‚úÖ Imagem enviada com sucesso!"
      - echo "üîñ Tag final: ${TAG_FINAL}"
      - echo "IMAGE_URI=${ECR_URI}:${TAG_FINAL}" >> build.env

artifacts:
  files:
    - build.env